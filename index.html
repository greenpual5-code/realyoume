<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>You&Meçš„å›å¿†å½•</title>
<link rel="stylesheet" href="style.css">
<style>
/* ===========================
   é»‘é‡‘æç®€ Â· ç§»åŠ¨ä¼˜å…ˆæ ·å¼
   =========================== */
:root{
  --bg:#0b0b0b;
  --card:#0f0f10;
  --muted:#bdb6a8;
  --gold:#ffd36b;
  --accent:#ffb86b;
  --glass: rgba(255,211,107,0.06);
  --shadow: 0 8px 30px rgba(0,0,0,0.6);
  font-family: "Helvetica Neue","PingFang SC","Microsoft Yahei",Arial,sans-serif;
  color-scheme: dark;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:
  radial-gradient(1200px 600px at 10% 10%, rgba(255,211,107,0.02), transparent 10%),
  linear-gradient(180deg,#060606 0%, #0b0b0b 100%);
  color:#fff; -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  padding:12px 12px 24px 12px;
}

/* container */
.app{max-width:760px;margin:0 auto;}

/* header / top bar */
.topbar{display:flex;align-items:center;gap:12px}
.hamburger{
  width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg, rgba(255,211,107,0.06), transparent);
  display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.04);
  cursor:pointer;
}
.title{
  display:flex;flex-direction:column;
}
.title h1{margin:0;font-size:16px;letter-spacing:0.6px}
.title p{margin:0;font-size:12px;color:var(--muted)}

/* cover / intro */
.cover{
  margin-top:12px;border-radius:14px;padding:14px;background:linear-gradient(180deg, rgba(255,211,107,0.03), rgba(255,211,107,0.01));
  border:1px solid rgba(255,211,107,0.06); box-shadow: var(--shadow);
  display:flex;gap:12px;align-items:center;
}
.avatars{
  width:78px;height:78px;border-radius:14px;background:linear-gradient(135deg,#111,#222);display:flex;align-items:center;justify-content:center;
  flex-shrink:0;border:1px solid rgba(255,255,255,0.03);
}
.avatars .heart{color:var(--gold);font-size:30px}
.intro{flex:1}
.intro .names{font-weight:700;font-size:16px}
.intro .desc{font-size:13px;color:var(--muted);margin-top:6px}

/* countdown */
.countdown{margin-top:10px;display:flex;gap:8px;align-items:center}
.countdown .box{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);font-weight:700}
.countdown .label{font-size:12px;color:var(--muted)}

/* main content */
.controls{display:flex;gap:8px;margin-top:12px;align-items:center}
.search{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}
.btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);font-weight:700}
.btn.primary{background:linear-gradient(90deg,var(--gold),var(--accent));color:#111;border:none}

/* timeline */
.timeline{margin-top:12px;display:flex;flex-direction:column;gap:12px;padding-bottom:120px}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 12px 30px rgba(0,0,0,0.6);
  display:flex;gap:10px;align-items:flex-start;
}
.meta{min-width:72px;color:var(--muted);font-size:12px;text-align:center}
.card .content{flex:1}
.card h3{margin:0;font-size:15px}
.card p{margin:8px 0 0 0;color:var(--muted);white-space:pre-wrap;font-size:13px}
.thumb{width:84px;height:64px;border-radius:8px;object-fit:cover;flex-shrink:0}

/* floating add button */
.fab{
  position:fixed;right:18px;bottom:26px;width:62px;height:62px;border-radius:16px;background:linear-gradient(180deg,var(--gold),var(--accent));
  display:flex;align-items:center;justify-content:center;color:#111;font-size:28px;box-shadow:0 20px 50px rgba(0,0,0,0.6);border:none;z-index:40;
  -webkit-tap-highlight-color: transparent;
}

/* drawer menu */
.drawer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;z-index:60}
.drawer{position:fixed;left:0;top:0;bottom:0;width:78%;max-width:360px;background:linear-gradient(180deg,#0b0b0b,#0f0f0f);padding:18px;border-right:1px solid rgba(255,255,255,0.03);transform:translateX(-110%);transition:transform .28s;z-index:70}
.drawer h2{margin:0 0 6px 0}
.drawer .muted{color:var(--muted);font-size:13px;margin-bottom:12px}
.drawer .menu{display:flex;flex-direction:column;gap:8px}
.drawer .menu button{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;border:none;background:transparent;color:#fff;text-align:left;font-weight:700}
.drawer.open{transform:translateX(0)}
.drawer-backdrop.show{display:block}

/* album (as page) */
.album-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:12px}
.album-grid img{width:100%;height:92px;object-fit:cover;border-radius:8px}

/* modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:80}
.modal{width:min(720px,94vw);background:linear-gradient(180deg,#0b0b0b,#0f0f0f);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.input,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}
textarea{min-height:120px;resize:vertical}

/* small screens tweaks */
@media(min-width:700px){
  body{padding:24px}
  .cover{padding:18px}
}

/* print styles (ç”¨äºå¯¼å‡º PDF) */
@media print{
  body{background:#fff;color:#000}
  .fab,.topbar,.controls,.drawer,.drawer-backdrop{display:none}
  .card{border:none;box-shadow:none;background:transparent}
}
</style>
</head>
<body>
<div class="app">
  <!-- top bar -->
  <div class="topbar">
    <div class="hamburger" id="btn-hamburger" title="èœå•">
      <svg width="20" height="14" viewBox="0 0 24 24" fill="none" aria-hidden>
        <rect x="3" y="5" width="18" height="2" rx="1" fill="#ffd36b"/>
        <rect x="3" y="11" width="18" height="2" rx="1" fill="#ffd36b"/>
        <rect x="3" y="17" width="18" height="2" rx="1" fill="#ffd36b"/>
      </svg>
    </div>
    <div class="title">
      <h1>You&Meçš„å›å¿†å½•</h1>
      <p>é»‘é‡‘ Â· æç®€ Â· ç§å¯†ä¿å­˜åœ¨ä½ çš„æ‰‹æœº</p>
    </div>
  </div>

  <!-- cover -->
  <section class="cover" id="cover">
    <div class="avatars">
      <div class="heart">â¤</div>
    </div>
    <div class="intro">
      <div class="names" id="couple-names">ä½  & å¥¹</div>
      <div class="desc" id="couple-desc">è®°å½•æˆ‘ä»¬çš„æ—¥å¸¸ä¸ç‰¹åˆ«æ—¶åˆ»</div>

      <div class="countdown" style="margin-top:10px">
        <div>
          <div class="label">ä¸‹ä¸€çºªå¿µæ—¥</div>
          <div class="box" id="next-ann">â€”</div>
        </div>
        <div style="margin-left:8px">
          <div class="label">å€’è®¡æ—¶</div>
          <div class="box" id="countdown-days">â€” å¤©</div>
        </div>
      </div>
    </div>
  </section>

  <!-- controls -->
  <div class="controls">
    <input id="q" class="search" placeholder="æœç´¢æ ‡é¢˜ / å†…å®¹ / æ ‡ç­¾..." />
    <button id="btn-album" class="btn" title="ç›¸å†Œ">ç›¸å†Œ</button>
    <button id="btn-export" class="btn" title="å¯¼å‡ºå¤‡ä»½">å¯¼å‡º</button>
    <button id="btn-settings" class="btn primary" title="è®¾ç½®">è®¾ç½®</button>
  </div>

  <!-- timeline -->
  <div id="timeline" class="timeline" aria-live="polite"></div>

  <!-- floating add -->
  <button class="fab" id="btn-add" title="æ–°å¢">ï¼‹</button>
</div>

<!-- drawer -->
<div id="drawerBack" class="drawer-backdrop" aria-hidden="true"></div>
<aside id="drawer" class="drawer" aria-hidden="true">
  <h2>You&Me</h2>
  <div class="muted">èœå• Â· å¿«é€Ÿè¿›å…¥</div>
  <div class="menu">
    <button id="menu-home">ğŸ  é¦–é¡µ</button>
    <button id="menu-album">ğŸ–¼ï¸ å…¨éƒ¨ç›¸å†Œ</button>
    <button id="menu-countdown">â³ çºªå¿µæ—¥</button>
    <button id="menu-export">â¬‡ï¸ å¯¼å‡ºå¤‡ä»½</button>
    <button id="menu-import">â¬†ï¸ å¯¼å…¥å¤‡ä»½</button>
    <button id="menu-cloud">â˜ï¸ äº‘åŒæ­¥ï¼ˆå ä½ï¼‰</button>
    <button id="menu-clear" style="color:#ff8f8f">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
    <div style="height:12px"></div>
    <div class="muted" style="font-size:12px">æç¤ºï¼šå›¾ç‰‡ä»¥ base64 å­˜å‚¨ï¼Œå ç”¨æµè§ˆå™¨ç©ºé—´ã€‚å»ºè®®å¯¼å‡ºå¤‡ä»½å¹¶ä¿å­˜åˆ°äº‘ç›˜ã€‚</div>
  </div>
</aside>

<!-- hidden modals -->
<div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" id="modalContent"></div>
</div>

<input type="file" id="importFile" accept=".json" style="display:none" />

<script>
/* ===========================
   æ•°æ®æ¨¡å‹ä¸æŒä¹…åŒ–
   =========================== */
const KEY = 'youme_memories_v1';
let data = {
  memories: [], // {id,title,date,place,content,images:[{name,data}],tags:[],createdAt,updatedAt}
  settings: {
    names: 'ä½  & å¥¹',
    desc: 'è®°å½•æˆ‘ä»¬çš„æ—¥å¸¸ä¸ç‰¹åˆ«æ—¶åˆ»',
    anniversary: '', // ISO date (MM-DD used for yearly)
  }
};
const $ = id => document.getElementById(id);

/* load/save */
function loadAll() {
  try {
    const raw = localStorage.getItem(KEY);
    if (raw) data = JSON.parse(raw);
    else saveAll();
  } catch(e){
    console.error('åŠ è½½å¤±è´¥',e); saveAll();
  }
}
function saveAll(){ localStorage.setItem(KEY, JSON.stringify(data)); renderAll(); }

/* utils */
function uid(){return 'm'+Date.now().toString(36)+Math.random().toString(36).slice(2,6)}
function fmtDate(d){
  if(!d) return '';
  const t = new Date(d);
  if(isNaN(t)) return d;
  return t.toLocaleDateString();
}
function isoToYYYYMMDD(iso){ if(!iso) return ''; try{ return new Date(iso).toISOString().slice(0,10);}catch(e){return ''} }

/* ===========================
   æ¸²æŸ“
   =========================== */
function renderAll(){
  renderCover();
  renderTimeline();
}
function renderCover(){
  $('couple-names').textContent = data.settings.names || 'ä½  & å¥¹';
  $('couple-desc').textContent = data.settings.desc || 'è®°å½•æˆ‘ä»¬çš„æ—¥å¸¸ä¸ç‰¹åˆ«æ—¶åˆ»';
  // next anniversary & countdown
  const ann = data.settings.anniversary; // expecting "YYYY-MM-DD" or "MM-DD"
  if(!ann){ $('next-ann').textContent = 'æœªè®¾ç½®'; $('countdown-days').textContent = 'â€”'; return; }
  // calculate next occurrence
  const today = new Date();
  let [m,d,y] = ann.split('-');
  if(m && m.length===2 && d && d.length===2 && y && y.length===4){
    // full date provided: use anniversary month-day; find next year >=
    const annDateThisYear = new Date(today.getFullYear(), Number(m)-1, Number(d));
    let next = annDateThisYear;
    if(next < today) next = new Date(today.getFullYear()+1, Number(m)-1, Number(d));
    const diff = Math.ceil((next - today)/(24*3600*1000));
    $('next-ann').textContent = `${next.getFullYear()}-${String(Number(m)).padStart(2,'0')}-${String(Number(d)).padStart(2,'0')}`;
    $('countdown-days').textContent = diff + ' å¤©';
  } else if(m && d && m.length<=2){
    // treated as MM-DD
    const mm = String(Number(m)).padStart(2,'0'), dd = String(Number(d)).padStart(2,'0');
    let next = new Date(today.getFullYear(), Number(mm)-1, Number(dd));
    if(next < today) next = new Date(today.getFullYear()+1, Number(mm)-1, Number(dd));
    const diff = Math.ceil((next - today)/(24*3600*1000));
    $('next-ann').textContent = `${mm}-${dd}`;
    $('countdown-days').textContent = diff + ' å¤©';
  } else {
    $('next-ann').textContent = ann;
    $('countdown-days').textContent = 'â€”';
  }
}

function renderTimeline(){
  const container = $('timeline'); container.innerHTML = '';
  const q = $('q').value.trim().toLowerCase();
  let list = [...data.memories];
  list.sort((a,b)=> new Date(b.date || b.createdAt) - new Date(a.date || a.createdAt));
  if(q) list = list.filter(m => (m.title||'').toLowerCase().includes(q) || (m.content||'').toLowerCase().includes(q) || (m.tags||[]).join(' ').toLowerCase().includes(q));
  if(list.length===0){ container.innerHTML = `<div style="padding:18px;text-align:center;color:var(--muted)">æš‚æ— è®°å¿† â€” ç‚¹å‡»å³ä¸‹è§’â€œï¼‹â€æ·»åŠ ä½ ä»¬çš„æ•…äº‹</div>`; return; }
  for(const m of list){
    const el = document.createElement('article'); el.className = 'card';
    const meta = document.createElement('div'); meta.className='meta';
    meta.innerHTML = `<div style="font-weight:800">${fmtDate(m.date||m.createdAt)}</div><div style="margin-top:6px;color:var(--muted);font-size:12px">${m.place||''}</div>`;
    el.appendChild(meta);
    const content = document.createElement('div'); content.className='content';
    const h = document.createElement('h3'); h.textContent = m.title || '(æ— æ ‡é¢˜)';
    const p = document.createElement('p'); p.textContent = m.content || '';
    content.appendChild(h); content.appendChild(p);
    if(m.tags && m.tags.length){
      const tdiv = document.createElement('div'); tdiv.style.marginTop='8px';
      for(const tag of m.tags){
        const span = document.createElement('span'); span.textContent = tag; span.style.cssText='display:inline-block;margin-right:6px;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:12px;color:var(--muted)';
        tdiv.appendChild(span);
      }
      content.appendChild(tdiv);
    }
    el.appendChild(content);
    if(m.images && m.images.length){
      const img = document.createElement('img'); img.className='thumb'; img.src = m.images[0].data; el.appendChild(img);
    }
    // actions
    const actions = document.createElement('div'); actions.style.marginLeft='auto'; actions.style.display='flex'; actions.style.gap='6px';
    const btnView = document.createElement('button'); btnView.className='btn'; btnView.textContent='æŸ¥çœ‹'; btnView.onclick = ()=> openView(m.id);
    const btnEdit = document.createElement('button'); btnEdit.className='btn'; btnEdit.textContent='ç¼–è¾‘'; btnEdit.onclick = ()=> openEdit(m.id);
    const btnDel = document.createElement('button'); btnDel.className='btn'; btnDel.style.color='#ff9b9b'; btnDel.textContent='åˆ é™¤'; btnDel.onclick = ()=> { if(confirm('åˆ é™¤è¯¥è®°å¿†ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤å›')){ data.memories = data.memories.filter(x=>x.id!==m.id); saveAll(); } };
    actions.appendChild(btnView); actions.appendChild(btnEdit); actions.appendChild(btnDel);
    el.appendChild(actions);
    container.appendChild(el);
  }
}

/* ===========================
   CRUD: æ–°å»º / ç¼–è¾‘ / æŸ¥çœ‹
   =========================== */
function openModal(html) {
  const mb = $('modalBackdrop'), mc = $('modalContent');
  mc.innerHTML = html;
  mb.style.display = 'flex'; mb.setAttribute('aria-hidden','false');
}
function closeModal(){ $('modalBackdrop').style.display='none'; $('modalBackdrop').setAttribute('aria-hidden','true'); $('modalContent').innerHTML=''; }

function openAdd(){
  openModal(`
    <h3 style="margin-top:0">æ·»åŠ æ–°è®°å¿†</h3>
    <label class="small">æ ‡é¢˜</label><input id="f-title" class="input" placeholder="ä¾‹å¦‚ï¼šæµ·è¾¹çš„é‚£ä¸ªä¸‹åˆ" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <div style="flex:1">
        <label class="small">æ—¥æœŸ</label><input id="f-date" class="input" type="date" />
      </div>
      <div style="width:110px">
        <label class="small">åœ°ç‚¹</label><input id="f-place" class="input" placeholder="åŸå¸‚ / åœ°ç‚¹" />
      </div>
    </div>
    <label class="small" style="margin-top:8px">å†…å®¹</label><textarea id="f-content" class="input" placeholder="å†™ä¸‹é‚£å¤©çš„æ•…äº‹ã€å°è¯æˆ–å¿ƒæƒ…"></textarea>
    <label class="small" style="margin-top:8px">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label><input id="f-tags" class="input" placeholder="æ—…è¡Œ,æƒŠå–œ" />
    <label class="small" style="margin-top:8px">ä¸Šä¼ ç…§ç‰‡ï¼ˆå¤šé€‰ï¼‰</label><input id="f-files" type="file" accept="image/*" multiple class="input" />
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn" id="c-cancel">å–æ¶ˆ</button>
      <button class="btn primary" id="c-save">ä¿å­˜</button>
    </div>
  `);
  $('c-cancel').onclick = closeModal;
  $('c-save').onclick = async ()=>{
    const title = $('f-title').value.trim();
    const date = $('f-date').value;
    const place = $('f-place').value.trim();
    const content = $('f-content').value.trim();
    const tags = $('f-tags').value.split(',').map(s=>s.trim()).filter(Boolean);
    const files = Array.from($('f-files').files || []);
    const images = [];
    for(const f of files){
      images.push({name: f.name, data: await fileToBase64(f)});
    }
    data.memories.push({id: uid(), title, date, place, content, tags, images, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString()});
    saveAll();
    closeModal();
  };
}

function openEdit(id){
  const m = data.memories.find(x=>x.id===id); if(!m) return;
  openModal(`
    <h3 style="margin-top:0">ç¼–è¾‘è®°å¿†</h3>
    <label class="small">æ ‡é¢˜</label><input id="f-title" class="input" value="${escapeHtml(m.title||'')}" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <div style="flex:1">
        <label class="small">æ—¥æœŸ</label><input id="f-date" class="input" type="date" value="${isoToYYYYMMDD(m.date)}" />
      </div>
      <div style="width:110px">
        <label class="small">åœ°ç‚¹</label><input id="f-place" class="input" value="${escapeHtml(m.place||'')}" />
      </div>
    </div>
    <label class="small" style="margin-top:8px">å†…å®¹</label><textarea id="f-content" class="input">${escapeHtml(m.content||'')}</textarea>
    <label class="small" style="margin-top:8px">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label><input id="f-tags" class="input" value="${(m.tags||[]).join(',')}" />
    <div style="margin-top:8px">
      <label class="small">å½“å‰ç…§ç‰‡é¢„è§ˆ</label>
      <div id="img-preview" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px"></div>
    </div>
    <label class="small" style="margin-top:8px">è¿½åŠ ä¸Šä¼ ç…§ç‰‡ï¼ˆå¤šé€‰ï¼‰</label><input id="f-files" type="file" accept="image/*" multiple class="input" />
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn" id="c-cancel">å–æ¶ˆ</button>
      <button class="btn primary" id="c-save">ä¿å­˜</button>
    </div>
  `);
  const preview = document.getElementById('img-preview');
  for(const im of m.images || []){
    const box = document.createElement('div'); box.style.width='90px'; box.style.height='70px'; box.style.overflow='hidden'; box.style.borderRadius='8px';
    const img = document.createElement('img'); img.src = im.data; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
    box.appendChild(img); preview.appendChild(box);
  }
  $('c-cancel').onclick = closeModal;
  $('c-save').onclick = async ()=>{
    m.title = $('f-title').value.trim();
    m.date = $('f-date').value;
    m.place = $('f-place').value.trim();
    m.content = $('f-content').value.trim();
    m.tags = $('f-tags').value.split(',').map(s=>s.trim()).filter(Boolean);
    const newFiles = Array.from($('f-files').files || []);
    for(const f of newFiles) m.images.push({name: f.name, data: await fileToBase64(f)});
    m.updatedAt = new Date().toISOString();
    saveAll(); closeModal();
  };
}

function openView(id){
  const m = data.memories.find(x=>x.id===id); if(!m) return;
  let imgsHtml = '';
  for(const im of m.images || []) imgsHtml += `<img src="${im.data}" style="width:100%;border-radius:8px;margin-top:8px">`;
  openModal(`
    <h3 style="margin-top:0">${escapeHtml(m.title||'(æ— æ ‡é¢˜)')}</h3>
    <div style="color:var(--muted);font-size:13px">${fmtDate(m.date||m.createdAt)} ${m.place?(' Â· '+escapeHtml(m.place)):''}</div>
    <div style="margin-top:10px;white-space:pre-wrap;color:var(--muted)">${escapeHtml(m.content||'')}</div>
    ${imgsHtml}
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button class="btn" id="v-close">å…³é—­</button>
      <button class="btn" id="v-edit">ç¼–è¾‘</button>
    </div>
  `);
  $('v-close').onclick = closeModal;
  $('v-edit').onclick = ()=>{ closeModal(); openEdit(id); };
}

/* ===========================
   å¯¼å…¥ / å¯¼å‡º / æ‰“å° / æ¸…ç©º
   =========================== */
function exportBackup(){
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = `youme-backup-${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
}
function importBackup(file){
  const fr = new FileReader();
  fr.onload = ()=>{
    try{
      const parsed = JSON.parse(fr.result);
      if(parsed && parsed.memories && Array.isArray(parsed.memories)){
        // merge with new ids if missing
        for(const item of parsed.memories){
          if(!item.id) item.id = uid();
          data.memories.push(item);
        }
        // merge settings if provided
        if(parsed.settings) data.settings = {...data.settings, ...parsed.settings};
        saveAll(); alert('å¯¼å…¥æˆåŠŸ');
      } else alert('æ–‡ä»¶ç»“æ„ä¸ç¬¦åˆ');
    }catch(e){ alert('å¯¼å…¥å¤±è´¥ï¼š'+e.message) }
  };
  fr.readAsText(file);
}

/* ===========================
   settings: anniversary / names / cloud placeholder
   =========================== */
function openSettings(){
  openModal(`
    <h3 style="margin-top:0">è®¾ç½®</h3>
    <label class="small">æƒ…ä¾£æ ‡é¢˜ï¼ˆé¦–é¡µæ˜¾ç¤ºï¼‰</label><input id="s-names" class="input" value="${escapeHtml(data.settings.names||'ä½  & å¥¹')}" />
    <label class="small" style="margin-top:8px">ç®€ä»‹ï¼ˆé¦–é¡µå°æç¤ºï¼‰</label><input id="s-desc" class="input" value="${escapeHtml(data.settings.desc||'è®°å½•æˆ‘ä»¬çš„æ—¥å¸¸ä¸ç‰¹åˆ«æ—¶åˆ»')}" />
    <label class="small" style="margin-top:8px">çºªå¿µæ—¥ï¼ˆæ¯å¹´é‡å¤ï¼‰</label>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="s-ann-mmdd" class="input" placeholder="MM-DDï¼ˆä¾‹å¦‚ï¼š05-02ï¼‰" value="${data.settings.anniversary && data.settings.anniversary.length===5 ? data.settings.anniversary : (data.settings.anniversary && data.settings.anniversary.length===10 ? data.settings.anniversary.slice(5) : '')}" />
      <div style="font-size:12px;color:var(--muted)">æˆ–è¾“å…¥ YYYY-MM-DD ç”¨äºç²¾ç¡®å¹´ä»½</div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn" id="s-cancel">å–æ¶ˆ</button>
      <button class="btn primary" id="s-save">ä¿å­˜</button>
    </div>
    <div style="height:6px"></div>
    <div style="border-top:1px solid rgba(255,255,255,0.03);margin-top:8px;padding-top:8px">
      <div class="muted" style="font-size:13px">äº‘åŒæ­¥åŠŸèƒ½ä¸ºå ä½ï¼ˆåç»­å¯æ¥å…¥ Firebase / è‡ªå»ºåç«¯ï¼‰ã€‚</div>
    </div>
  `);
  $('s-cancel').onclick = closeModal;
  $('s-save').onclick = ()=>{
    data.settings.names = $('s-names').value.trim()||'ä½  & å¥¹';
    data.settings.desc = $('s-desc').value.trim()||'è®°å½•æˆ‘ä»¬çš„æ—¥å¸¸ä¸ç‰¹åˆ«æ—¶åˆ»';
    const a = $('s-ann-mmdd').value.trim();
    if(a) data.settings.anniversary = a;
    saveAll(); closeModal();
  };
}

/* ===========================
   small helpers
   =========================== */
function fileToBase64(file){
  return new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> res(fr.result);
    fr.onerror = ()=> rej(new Error('è¯»å–å¤±è´¥'));
    fr.readAsDataURL(file);
  });
}
function escapeHtml(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

/* ===========================
   Drawer & events
   =========================== */
const drawer = $('drawer'), back = $('drawerBack');
function openDrawer(){ drawer.classList.add('open'); back.classList.add('show'); drawer.setAttribute('aria-hidden','false'); back.setAttribute('aria-hidden','false'); }
function closeDrawer(){ drawer.classList.remove('open'); back.classList.remove('show'); drawer.setAttribute('aria-hidden','true'); back.setAttribute('aria-hidden','true'); }
$('btn-hamburger').onclick = ()=> openDrawer();
back.onclick = ()=> closeDrawer();
$('menu-home').onclick = ()=>{ closeDrawer(); window.scrollTo({top:0,behavior:'smooth'}) };
$('menu-album').onclick = ()=>{ closeDrawer(); openAlbum(); };
$('menu-countdown').onclick = ()=>{ closeDrawer(); openSettings(); };
$('menu-export').onclick = ()=>{ closeDrawer(); exportBackup(); };
$('menu-import').onclick = ()=>{ closeDrawer(); $('importFile').click(); };
$('menu-clear').onclick = ()=>{ if(confirm('ç¡®è®¤æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤')){ data.memories=[]; saveAll(); } };
$('menu-cloud').onclick = ()=>{ closeDrawer(); alert('äº‘åŒæ­¥ä¸ºå ä½ï¼ˆéœ€åç«¯/ç¬¬ä¸‰æ–¹æœåŠ¡ï¼‰ã€‚å¦‚éœ€æˆ‘å¸®ä½ æ­å»º Firebase åŒæ­¥æ–¹æ¡ˆï¼Œæˆ‘å¯ä»¥ç”Ÿæˆå®Œæ•´ä»£ç ä¸éƒ¨ç½²æ­¥éª¤ï¼‰'); };

/* main controls */
$('btn-add').onclick = openAdd;
$('btn-album').onclick = openAlbum;
$('btn-export').onclick = exportBackup;
$('btn-settings').onclick = openSettings;

/* import file handler */
$('importFile').onchange = (e)=>{ const f = e.target.files[0]; if(f) importBackup(f); e.target.value=''; };

/* album page (modal) */
function openAlbum(){
  const photos = data.memories.flatMap(m => (m.images||[]).map(im => ({id:m.id, src:im.data, title:m.title || fmtDate(m.date)})));
  let html = `<h3 style="margin-top:0">ç›¸å†Œ Â· å…± ${photos.length} å¼ </h3>`;
  if(photos.length===0) html += `<div style="padding:18px;text-align:center;color:var(--muted)">æš‚æ— ç…§ç‰‡ï¼Œå¿«å»æ·»åŠ ç¬¬ä¸€å¼ åˆå½±å§</div>`;
  else {
    html += `<div class="album-grid">`;
    for(const p of photos) html += `<img src="${p.src}" onclick="(function(){closeModal(); openView('${p.id}')})()" />`;
    html += `</div>`;
  }
  html += `<div style="display:flex;justify-content:flex-end;margin-top:12px"><button class="btn" onclick="closeModal()">å…³é—­</button></div>`;
  openModal(html);
}

/* search debounce */
let hSearch;
$('q').addEventListener('input', ()=>{ clearTimeout(hSearch); hSearch = setTimeout(()=> renderTimeline(), 220) });

/* init */
loadAll();

/* helpful: prompt user to add to home screen (only a note, not PWA) */
setTimeout(()=> {
  if (/iphone|ipad|ipod|android|mobile/i.test(navigator.userAgent)) {
    // show small unobtrusive tip once per device
    if(!localStorage.getItem(KEY+'_tip')) {
      if(confirm('æç¤ºï¼šå¯æŠŠæ­¤é¡µé¢â€œæ·»åŠ åˆ°ä¸»å±å¹•â€ï¼Œä»¥ä¾¿åƒ App ä½¿ç”¨ã€‚ç°åœ¨æ‰“å¼€å¸®åŠ©è¯´æ˜ï¼Ÿ')) {
        alert('iOS: Safari -> å…±äº« -> æ·»åŠ åˆ°ä¸»å±å¹•\nAndroid: Chrome -> èœå• -> æ·»åŠ åˆ°ä¸»å±å¹•');
      }
      localStorage.setItem(KEY+'_tip','1');
    }
  }
}, 1200);

/* keyboard shortcuts for desktop testing */
window.addEventListener('keydown', (e)=>{
  if(e.key==='n') openAdd();
});

/* expose minimal API for modal onclick images */
window.openView = openView;

/* end of script */
</script>
</body>
</html>
